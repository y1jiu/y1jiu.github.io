<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>第一次搭建 Kubernetes - 一旧的博客</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<meta name="author" content="Yijiu" /><meta name="description" content="前言 初次尝试 Kubernetes 的安装部署，设备是两台云服务器，使用的工具是 kubeadm ，使用它部署一个完整的 Kubernetes 集群。其中会提到很多注意事项。初次尝试，欢迎吐槽。 准备工" /><meta name="keywords" content="Hugo, theme, even" />






<meta name="generator" content="Hugo 0.88.1 with theme even" />


<link rel="canonical" href="http://localhost:1313/post/cn_k8s/%E6%90%AD%E5%BB%BAkubernetes/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.b5a744db6de49a86cadafb3b70f555ab443f83c307a483402259e94726b045ff.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">


<meta property="og:title" content="第一次搭建 Kubernetes" />
<meta property="og:description" content="前言 初次尝试 Kubernetes 的安装部署，设备是两台云服务器，使用的工具是 kubeadm ，使用它部署一个完整的 Kubernetes 集群。其中会提到很多注意事项。初次尝试，欢迎吐槽。 准备工" />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://localhost:1313/post/cn_k8s/%E6%90%AD%E5%BB%BAkubernetes/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2019-11-10T01:37:56+08:00" />
<meta property="article:modified_time" content="2019-11-10T01:37:56+08:00" />

<meta itemprop="name" content="第一次搭建 Kubernetes">
<meta itemprop="description" content="前言 初次尝试 Kubernetes 的安装部署，设备是两台云服务器，使用的工具是 kubeadm ，使用它部署一个完整的 Kubernetes 集群。其中会提到很多注意事项。初次尝试，欢迎吐槽。 准备工"><meta itemprop="datePublished" content="2019-11-10T01:37:56+08:00" />
<meta itemprop="dateModified" content="2019-11-10T01:37:56+08:00" />
<meta itemprop="wordCount" content="3885">
<meta itemprop="keywords" content="Linux,Kubernetes,cloud native," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="第一次搭建 Kubernetes"/>
<meta name="twitter:description" content="前言 初次尝试 Kubernetes 的安装部署，设备是两台云服务器，使用的工具是 kubeadm ，使用它部署一个完整的 Kubernetes 集群。其中会提到很多注意事项。初次尝试，欢迎吐槽。 准备工"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">Y1jiu</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">主页</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">归档</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">分类</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">标签</li>
      </a><a href="/more/">
        <li class="mobile-menu-item">更多</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">Y1jiu</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">主页</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">归档</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">分类</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">标签</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/more/">更多</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">第一次搭建 Kubernetes</h1>

      <div class="post-meta">
        <span class="post-time"> 2019-11-10 </span>
        <div class="post-category">
            <a href="/categories/kubernetes/"> Kubernetes </a>
            </div>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Contents</h2>
  <div class="post-toc-content always-active">
    <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li>
          <ul>
            <li><a href="#前言"><strong>前言</strong></a></li>
            <li><a href="#准备工作"><strong>准备工作</strong></a></li>
            <li><a href="#设备准备"><strong>设备准备</strong></a></li>
            <li><a href="#实现目标"><strong>实现目标</strong></a></li>
            <li><a href="#前期准备"><strong>前期准备</strong></a></li>
            <li><a href="#修改-hostname-和-hosts"><strong>修改 hostname 和 hosts</strong></a></li>
            <li><a href="#配置防火墙"><strong>配置防火墙</strong></a></li>
            <li><a href="#禁用-selinux"><strong>禁用 SELinux</strong></a></li>
            <li><a href="#禁用交换分区"><strong>禁用交换分区</strong></a></li>
            <li><a href="#安装-docker"><strong>安装 Docker</strong></a></li>
            <li><a href="#安装-kubernetes"><strong>安装 Kubernetes</strong></a></li>
            <li><a href="#初始化-master-节点"><strong>初始化 Master 节点</strong></a></li>
            <li><a href="#安装-dashboard"><strong>安装 Dashboard</strong></a></li>
            <li><a href="#添加-worker-节点"><strong>添加 Worker 节点</strong></a></li>
            <li><a href="#小结"><strong>小结</strong></a></li>
          </ul>
        </li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <h3 id="前言"><strong>前言</strong></h3>
<p>初次尝试 Kubernetes 的安装部署，设备是两台云服务器，使用的工具是 <strong>kubeadm</strong> ，使用它部署一个完整的 Kubernetes 集群。其中会提到很多注意事项。初次尝试，欢迎吐槽。</p>
<h3 id="准备工作"><strong>准备工作</strong></h3>
<ul>
<li>熟悉 Linux 命令</li>
<li>了解 Docker 容器技术</li>
<li>准备好2台或以上的云服务器（使用云服务器请阅读下面的设备准备！），或者使用虚拟机</li>
<li>云服务器和虚拟机具备30 GB 或以上的磁盘空间，主要用于 Docker 镜像和 日志文件</li>
<li>Linux 系统为64位，3.10 及以上的内核版本</li>
</ul>
<h3 id="设备准备"><strong>设备准备</strong></h3>
<p>我采用的是某云厂商的两台云服务器，配置一模一样。</p>
<blockquote>
<p>Kubernetes 官方最小机器配置: CPU &gt;= 2, 内存 &gt;= 2G。个人建议配置越高越好，有压力的可以使用虚拟机。</p>
</blockquote>
<p>我的机器配置：</p>
<table>
<thead>
<tr>
<th style="text-align:center">Master</th>
<th style="text-align:center">Node1</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">2核 CPU</td>
<td style="text-align:center">2核 CPU</td>
</tr>
<tr>
<td style="text-align:center">8G 内存</td>
<td style="text-align:center">8G 内存</td>
</tr>
<tr>
<td style="text-align:center">CentOS7.6 64位</td>
<td style="text-align:center">CentOS7.6 64位</td>
</tr>
<tr>
<td style="text-align:center">内网互通</td>
<td style="text-align:center">内网互通</td>
</tr>
<tr>
<td style="text-align:center">外网访问权限不受限制</td>
<td style="text-align:center">外网访问权限不受限制</td>
</tr>
<tr>
<td style="text-align:center">外网宽带：1Mbps</td>
<td style="text-align:center">外网宽带：1Mbps</td>
</tr>
</tbody>
</table>
<blockquote>
<p>外网宽带不做限制，当然越大越好</p>
<p>不同的Linux 操作系统配置差别不大，使用 Ubuntu 也可以</p>
</blockquote>
<h4 id="内网互通很重要"><strong>内网互通（很重要）</strong></h4>
<p>Kubernetes 的节点之间需要内网互通，虚拟机内网互通的方法不阐述了，来讲讲云服务器之间如何实现内网互通。</p>
<p>在云平台的控制台中，需要创建一个<strong>私有网络（VPC）</strong>，创建中需要先选择一个<strong>地域</strong>（区域），根据云服务器所在地域选择。两台云服务器的地域必须相同，<strong>可用区</strong>最好相同（部分厂商可以跨区，但是可能比较麻烦）。名称随意，最好有特征（k8s_vpc_xxxx）。<strong>CIDR</strong> 一般有<code>10</code> 、<code>172</code> 、<code>192</code> 的头选择，选择<code>10</code> 和 <code>192</code> 都可以，不建议选择 <code>172</code>，因为可能会和Docker 容器的 IP 地址冲突。</p>
<p>创建完私有网络（VPC）后，<strong>新建子网</strong>，地域选择相同，名称随意，私有网络选择我们刚刚建好的 VPC，其他不变。</p>
<p>在子网建好后，可以选购云服务器了，云服务器必须在同一地域，比如都在华东。可用区最好一起，部分厂商有解决不同可用区的内网互通方案，有需求的自行查询。</p>
<p>选购云服务器时，两台服务器的<strong>网络配置</strong>里，私有网络和子网选项，都需要选择我们刚刚创建好的。内网 IP 可以自定义也可以自动分配。</p>
<p>自此，两台云服务器实现了内网互通。</p>
<p>我的 Master 节点的内网IP 为：10.0.0.3</p>
<p>Node1 节点的内网IP 为：10.0.0.4</p>
<p>同属同一个私有网络里的子网。</p>
<blockquote>
<p>不同云厂商的私有网络配置会有不同，可以查看帮助文档完成。</p>
</blockquote>
<h3 id="实现目标"><strong>实现目标</strong></h3>
<ul>
<li>
<p>在所有节点上安装 Docker 和 kubeadm</p>
</li>
<li>
<p>部署 Kubernetes Master</p>
</li>
<li>
<p>部署 Kubernetes Worker</p>
</li>
<li>
<p>使用 Dashboard 插件提供了可视化的 Web 界面</p>
</li>
</ul>
<h3 id="前期准备"><strong>前期准备</strong></h3>
<p><strong>接下来开始云服务器内的操作，真正的开始部署 Kubernetes 了。</strong></p>
<blockquote>
<p>我的一切操作是在 root 身份下进行。</p>
</blockquote>
<p>云服务器一般配置了厂商自家的软件源，新的云服务器可以直接执行以下命令更新：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash">$ yum makecache <span class="o">&amp;&amp;</span> yum -y update
</code></pre></td></tr></table>
</div>
</div><p>可以安装 vim 和 git，方便接下来的一些操作：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash">$ yum install vim git -y
</code></pre></td></tr></table>
</div>
</div><h3 id="修改-hostname-和-hosts"><strong>修改 hostname 和 hosts</strong></h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="c1"># master节点</span>
$ vim /etc/hostname
<span class="c1"># 改成 k8s-master</span>
$ cat /etc/hostname
k8s-master
<span class="c1"># 将IP地址指向 hostname</span>
$ vim /etc/hosts
<span class="c1">#添加</span>
10.0.0.3 k8s-master
10.0.0.4 k8s-node1
$ cat /etc/hosts <span class="p">|</span> grep k8s
10.0.0.3 k8s-master
10.0.0.4 k8s-node1

<span class="c1">#node1节点</span>
$ vim /etc/hostname
<span class="c1"># 改成 k8s-node1</span>
$ cat /etc/hostname 
k8s-node1
<span class="c1"># 将IP地址指向 hostname</span>
$ vim /etc/hosts
<span class="c1">#添加</span>
10.0.0.3 k8s-master
10.0.0.4 k8s-node1
$ cat /etc/hosts <span class="p">|</span> grep k8s
10.0.0.3 k8s-master
10.0.0.4 k8s-node1
</code></pre></td></tr></table>
</div>
</div><p>最后，在两台云服务器相互 <code>ping</code> 另一台主机的内网 IP：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="c1"># Master主机的操作</span>
$ ping 10.0.0.4 <span class="c1">#node1的内网ip</span>

<span class="c1"># Node1主机的操作</span>
$ ping 10.0.0.3 <span class="c1">#master的内网ip</span>
</code></pre></td></tr></table>
</div>
</div><p>如果 <code>ping</code> 成功，说明已经实现内网互通。</p>
<h3 id="配置防火墙"><strong>配置防火墙</strong></h3>
<p>这次部署只是测试环境，为了方便，直接把防火墙关闭，追求安全性可以参考相关文档，开放特定端口。执行下面的命令，关闭防火墙：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash">$ systemctl stop firewalld   <span class="c1"># 关闭服务</span>
$ systemctl disable firewalld    <span class="c1"># 禁用服务</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="禁用-selinux"><strong>禁用 SELinux</strong></h3>
<p>使用 <code>vim</code> 修改 <code>/etc/selinux/config</code> ，将 SELINUX 设置为 <code>SELINUX=disabled</code> ，然后重启机器。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="c1"># 查看 SELinux的状态</span>
$ sestatus 
SELinux status:                 disabled
</code></pre></td></tr></table>
</div>
</div><h3 id="禁用交换分区"><strong>禁用交换分区</strong></h3>
<p>通过 <code>vim</code> 编辑 <code>/etc/fstab</code>，将 swap 注释，然后重启机器。</p>
<p>没有 swap 行的话，忽略这一步。</p>
<h3 id="安装-docker"><strong>安装 Docker</strong></h3>
<p>可以参考这本电子书：<a href="https://yeasy.gitbooks.io/docker_practice/install/centos.html">Docker — 从入门到实践</a></p>
<ul>
<li>Docker 版本使用的是 <code>18.09</code>，Kubernetes 暂时不支持最新版的 Docker 19.x 。</li>
<li>我使用的是阿里云的 <code>yum</code> Docker 软件源：</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="c1"># 首先安装一些依赖包</span>
$ yum install -y yum-utils device-mapper-persistent-data lvm2

<span class="c1"># 添加软件源信息(阿里云)</span>
$ yum-config-manager --add-repo http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo

<span class="c1"># 查看Docker-CE的版本</span>
$ yum list docker-ce.x86_64 --showduplicates <span class="p">|</span> sort -r

<span class="c1"># 更新</span>
sudo yum makecache fast

<span class="c1"># 我选择了 18.09.9-3.el7 版本安装</span>
$ yum install docker-ce-18.09.9-3.el7 docker-ce-cli-18.09.9-3.el7 containerd.io
</code></pre></td></tr></table>
</div>
</div><p>安装完成后，通过命令 <code>docker version</code> 可以查看到 Docker 的版本信息。</p>
<p>建议将 <strong>Docker 镜像源</strong> 更换为国内的，我使用的是阿里云的镜像加速。只要有阿里云的账号，就可以使用。地址在 <code>阿里云 -&gt; 容器镜像服务 -&gt; 镜像中心 -&gt; 镜像加速器 -&gt; 加速器地址 </code> 。</p>
<p>每个人都有专属的镜像加速地址，只需将加速器地址添加到 <code>/etc/docker/daemon.json</code> 即可。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash">$ sudo mkdir -p /etc/docker
$ <span class="nb">cd</span> /etc/docker
$ vim daemon.json
<span class="c1">#添加以下内容</span>
<span class="o">{</span>
  <span class="s2">&#34;registry-mirrors&#34;</span>: <span class="o">[</span><span class="s2">&#34;https://xxxxxxx.mirror.aliyuncs.com&#34;</span><span class="o">]</span>
<span class="o">}</span>
<span class="c1">#每个人的地址不同，上面的只是示范</span>
</code></pre></td></tr></table>
</div>
</div><p>安装配置完成后执行下面的命令</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash">$ systemctl <span class="nb">enable</span> docker
$ systemctl start docker
</code></pre></td></tr></table>
</div>
</div><p>完成后，执行 <code>docker info</code> ，在 <code>Registry Mirrors:</code> 选项，如果可以看到我们输入的加速器地址，证明配置成功了。</p>
<h3 id="安装-kubernetes"><strong>安装 Kubernetes</strong></h3>
<p>前面一切就绪后，可以开始安装 Kubernetes 了！</p>
<h4 id="添加国内源"><strong>添加国内源</strong></h4>
<p>Kubernetes 需要访问外网，国内网络的问题，需要在 <code>yum</code> 源中添加阿里云的镜像源：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash">$ <span class="nb">cd</span> /etc/yum.repos.d/
$ vim kubernetes.repo
<span class="c1"># 添加以下内容</span>
<span class="o">[</span>kubernetes<span class="o">]</span>
<span class="nv">name</span><span class="o">=</span>Kubernetes
<span class="nv">baseurl</span><span class="o">=</span>http://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64
<span class="nv">enabled</span><span class="o">=</span><span class="m">1</span>
<span class="nv">gpgcheck</span><span class="o">=</span><span class="m">1</span>
<span class="nv">repo_gpgcheck</span><span class="o">=</span><span class="m">1</span>
<span class="nv">gpgkey</span><span class="o">=</span>http://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg http://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg
<span class="nv">exclude</span><span class="o">=</span>kube*
</code></pre></td></tr></table>
</div>
</div><h4 id="开始安装"><strong>开始安装</strong></h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash">$ yum install -y kubelet kubeadm kubectl --disableexcludes<span class="o">=</span>kubernetes
$ systemctl <span class="nb">enable</span> kubelet <span class="o">&amp;&amp;</span> systemctl start kubelet
</code></pre></td></tr></table>
</div>
</div><p>在上述安装的过程中，kubeadm 和 kubelet、kubectl 这几个二进制文件都会被自动安装好。</p>
<h4 id="修改网络配置"><strong>修改网络配置</strong></h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash">$ vim /etc/sysctl.d/k8s.conf
<span class="c1"># 添加以下内容</span>
net.bridge.bridge-nf-call-ip6tables <span class="o">=</span> <span class="m">1</span>
net.bridge.bridge-nf-call-iptables <span class="o">=</span> <span class="m">1</span>
$ sysctl --system
</code></pre></td></tr></table>
</div>
</div><blockquote>
<p><strong>上面所有操作，在 Master 和 Node 主机上都要执行。下面进行的，是 Master 节点的初始化。</strong></p>
</blockquote>
<h3 id="初始化-master-节点"><strong>初始化 Master 节点</strong></h3>
<h4 id="生成初始化文件"><strong>生成初始化文件</strong></h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash">$ kubeadm config print init-defaults &gt; kubeadm-init.yaml
</code></pre></td></tr></table>
</div>
</div><p><code>kubeadm-init.yaml</code> 文件里有两个地方需要修改：</p>
<ul>
<li>将 <code>advertiseAddress: 1.2.3.4 </code>修改为本机的内网IP 地址</li>
<li>将 <code>imageRepository: </code> 的 <code>k8s.gcr.io</code> 修改为：<code>registry.cn-hangzhou.aliyuncs.com/google_containers</code></li>
</ul>
<p>修改完毕的 yaml 文件：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">kubeadm.k8s.io/v1beta2</span><span class="w">
</span><span class="w"></span><span class="nt">bootstrapTokens</span><span class="p">:</span><span class="w">
</span><span class="w"></span>- <span class="nt">groups</span><span class="p">:</span><span class="w">
</span><span class="w">  </span>- <span class="l">system:bootstrappers:kubeadm:default-node-token</span><span class="w">
</span><span class="w">  </span><span class="nt">token</span><span class="p">:</span><span class="w"> </span><span class="l">abcdef.0123456789abcdef</span><span class="w">
</span><span class="w">  </span><span class="nt">ttl</span><span class="p">:</span><span class="w"> </span><span class="l">24h0m0s</span><span class="w">
</span><span class="w">  </span><span class="nt">usages</span><span class="p">:</span><span class="w">
</span><span class="w">  </span>- <span class="l">signing</span><span class="w">
</span><span class="w">  </span>- <span class="l">authentication</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">InitConfiguration</span><span class="w">
</span><span class="w"></span><span class="nt">localAPIEndpoint</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">advertiseAddress</span><span class="p">:</span><span class="w"> </span><span class="m">10.0.0.3</span><span class="w">
</span><span class="w">  </span><span class="nt">bindPort</span><span class="p">:</span><span class="w"> </span><span class="m">6443</span><span class="w">
</span><span class="w"></span><span class="nt">nodeRegistration</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">criSocket</span><span class="p">:</span><span class="w"> </span><span class="l">/var/run/dockershim.sock</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">k8s-master</span><span class="w">
</span><span class="w">  </span><span class="nt">taints</span><span class="p">:</span><span class="w">
</span><span class="w">  </span>- <span class="nt">effect</span><span class="p">:</span><span class="w"> </span><span class="l">NoSchedule</span><span class="w">
</span><span class="w">    </span><span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="l">node-role.kubernetes.io/master</span><span class="w">
</span><span class="w"></span><span class="nn">---</span><span class="w">
</span><span class="w"></span><span class="nt">apiServer</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">timeoutForControlPlane</span><span class="p">:</span><span class="w"> </span><span class="l">4m0s</span><span class="w">
</span><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">kubeadm.k8s.io/v1beta2</span><span class="w">
</span><span class="w"></span><span class="nt">certificatesDir</span><span class="p">:</span><span class="w"> </span><span class="l">/etc/kubernetes/pki</span><span class="w">
</span><span class="w"></span><span class="nt">clusterName</span><span class="p">:</span><span class="w"> </span><span class="l">kubernetes</span><span class="w">
</span><span class="w"></span><span class="nt">controllerManager</span><span class="p">:</span><span class="w"> </span>{}<span class="w">
</span><span class="w"></span><span class="nt">dns</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">CoreDNS</span><span class="w">
</span><span class="w"></span><span class="nt">etcd</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">local</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">dataDir</span><span class="p">:</span><span class="w"> </span><span class="l">/var/lib/etcd</span><span class="w">
</span><span class="w"></span><span class="nt">imageRepository</span><span class="p">:</span><span class="w"> </span><span class="l">registry.cn-hangzhou.aliyuncs.com/google_containers</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ClusterConfiguration</span><span class="w">
</span><span class="w"></span><span class="nt">kubernetesVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1.16.0</span><span class="w">
</span><span class="w"></span><span class="nt">networking</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">dnsDomain</span><span class="p">:</span><span class="w"> </span><span class="l">cluster.local</span><span class="w">
</span><span class="w">  </span><span class="nt">serviceSubnet</span><span class="p">:</span><span class="w"> </span><span class="m">10.96.0.0</span><span class="l">/12</span><span class="w">
</span><span class="w"></span><span class="nt">scheduler</span><span class="p">:</span><span class="w"> </span>{}<span class="w">
</span></code></pre></td></tr></table>
</div>
</div><h4 id="下载镜像"><strong>下载镜像</strong></h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash">$ kubeadm config images pull --config kubeadm-init.yaml
</code></pre></td></tr></table>
</div>
</div><p>下载下来的镜像，都可以通过命令 <code>docker images</code> 看到。</p>
<h4 id="初始化"><strong>初始化</strong></h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash">$ kubeadm init --config kubeadm-init.yaml
</code></pre></td></tr></table>
</div>
</div><p>如果提示 <code>[ERROR NumCPU]: the number of available CPUs 1 is less than the required 2</code> 的话，需要再 <code>kubeadm init</code> 后加上参数：<code>--ignore-preflight-errors=NumCPU</code> 。</p>
<p>初始化执行完成后，会输出以下内容：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">Your Kubernetes control-plane has initialized successfully!

To start using your cluster, you need to run the following as a regular user:

  mkdir -p <span class="nv">$HOME</span>/.kube
  sudo cp -i /etc/kubernetes/admin.conf <span class="nv">$HOME</span>/.kube/config
  sudo chown <span class="k">$(</span>id -u<span class="k">)</span>:<span class="k">$(</span>id -g<span class="k">)</span> <span class="nv">$HOME</span>/.kube/config

You should now deploy a pod network to the cluster.
Run <span class="s2">&#34;kubectl apply -f [podnetwork].yaml&#34;</span> with one of the options listed at:
  https://kubernetes.io/docs/concepts/cluster-administration/addons/

Then you can join any number of worker nodes by running the following on each as root:       
kubeadm join 10.0.0.3:6443 --token abcdef.0123456789abcdef <span class="se">\
</span><span class="se"></span>    --discovery-token-ca-cert-hash sha256:cb43abf70cbe7b48d107de76dba1a1e0d1b5d25a8bc5df20d766d82eb353df1f
</code></pre></td></tr></table>
</div>
</div><p>其中一条指令：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash">kubeadm join 10.0.0.3:6443 --token abcdef.0123456789abcdef <span class="se">\
</span><span class="se"></span>    --discovery-token-ca-cert-hash sha256:cb43abf70cbe7b48d107de76dba1a1e0d1b5d25a8bc5df20d766d82eb353df1f
</code></pre></td></tr></table>
</div>
</div><p>这个 kubeadm join 命令，就是用来给这个 Master 节点添加更多工作节点（Worker）的命令。我们在后面部署 Worker 节点的时候马上会用到它，所以找一个地方把这条命令记录下来。</p>
<p>此外，kubeadm 还会提示我们第一次使用 Kubernetes 集群所需要的配置命令：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash">$ mkdir -p <span class="nv">$HOME</span>/.kube
$ sudo cp -i /etc/kubernetes/admin.conf <span class="nv">$HOME</span>/.kube/config
$ sudo chown <span class="k">$(</span>id -u<span class="k">)</span>:<span class="k">$(</span>id -g<span class="k">)</span> <span class="nv">$HOME</span>/.kube/config
</code></pre></td></tr></table>
</div>
</div><p>执行上面这些配置命令的原因是，K8s 集群默认需要加密方式访问，这几条命令是将刚刚部署生成的 Kubernetes 集群的安全配置文件 <code>admin.conf</code> ，复制保存到当前用户的 <code>.kube</code> 目录里，这样 kubectl 默认会使用这个目录下的授权信息访问 K8s 集群，这样当前用户就可以执行 kubectl 命令：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash">$ kubectl get node
NAME         STATUS     ROLES    AGE   VERSION
k8s-master   NotReady   master   11m   v1.16.3
</code></pre></td></tr></table>
</div>
</div><p>k8s-master 的 STATUS 是 <code>NotReady</code> ，是因为我们没有部署任何网络插件。</p>
<h4 id="配置网络"><strong>配置网络</strong></h4>
<p>下载文件：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash">$ wget https://docs.projectcalico.org/v3.8/manifests/calico.yaml
$ cat kubeadm-init.yaml <span class="p">|</span> grep serviceSubnet:
  serviceSubnet: 10.96.0.0/12
</code></pre></td></tr></table>
</div>
</div><p>修改 <code>calico.yaml</code> ，将 <code>192.168.0.0/16</code> 修改为 <code>10.96.0.0/12</code> 。</p>
<blockquote>
<p>calico.yaml 里的 IP 要和 kubeadm-init.yaml 里的 IP 保持一致</p>
</blockquote>
<p>执行命令初始化网络：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash">$ kubectl apply -f calico.yaml
</code></pre></td></tr></table>
</div>
</div><p>再次通过 kubectl get 查看 node 的信息：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash">$ kubectl get node
NAME         STATUS   ROLES    AGE   VERSION
k8s-master   Ready    master   22m   v1.16.3
</code></pre></td></tr></table>
</div>
</div><p>状态变成 <code>Ready</code> 了。</p>
<h3 id="安装-dashboard"><strong>安装 Dashboard</strong></h3>
<p>Dashboard 可以给用户提供一个可视化的 Web 界面来查看当前集群的各种信息。</p>
<h4 id="部署-dashboard-可视化插件"><strong>部署 Dashboard 可视化插件</strong></h4>
<p>下载文件：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash">$ wget https://raw.githubusercontent.com/kubernetes/dashboard/v2.0.0-beta4/aio/deploy/recommended.yaml
$ kubectl apply -f recommended.yaml 
</code></pre></td></tr></table>
</div>
</div><p>部署完成后，查看 pods 的状态：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash">$ kubectl get pods --all-namespaces <span class="p">|</span> grep dashboard
NAMESPACE              NAME                                         READY   STATUS    RESTARTS 
kubernetes-dashboard   dashboard-metrics-scraper-566cddb686-zqqv4   1/1     Running   <span class="m">0</span>          7m38s
kubernetes-dashboard   kubernetes-dashboard-7b5bf5d559-rg2ch        1/1     Running   <span class="m">0</span>          7m38s
</code></pre></td></tr></table>
</div>
</div><h4 id="创建用户"><strong>创建用户</strong></h4>
<p>创建一个用于登录 Dashboard 的用户账号，创建文件 <code>dashboard-adminuser.yaml</code> ，内容如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ServiceAccount</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">admin-user</span><span class="w">
</span><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">kube-system</span><span class="w">
</span><span class="w"></span><span class="nn">---</span><span class="w">
</span><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">rbac.authorization.k8s.io/v1</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ClusterRoleBinding</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">admin-user</span><span class="w">
</span><span class="w"></span><span class="nt">roleRef</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">apiGroup</span><span class="p">:</span><span class="w"> </span><span class="l">rbac.authorization.k8s.io</span><span class="w">
</span><span class="w">  </span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ClusterRole</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">cluster-admin</span><span class="w">
</span><span class="w"></span><span class="nt">subjects</span><span class="p">:</span><span class="w">
</span><span class="w"></span>- <span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ServiceAccount</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">admin-user</span><span class="w">
</span><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">kube-system</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>完成后执行命令：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash">$ kubectl apply -f dashboard-adminuser.yaml
</code></pre></td></tr></table>
</div>
</div><h4 id="生成证书"><strong>生成证书</strong></h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash">$ grep <span class="s1">&#39;client-certificate-data&#39;</span> ~/.kube/config <span class="p">|</span> head -n <span class="m">1</span> <span class="p">|</span> awk <span class="s1">&#39;{print $2}&#39;</span> <span class="p">|</span> base64 -d &gt;&gt; kubecfg.crt
$ grep <span class="s1">&#39;client-key-data&#39;</span> ~/.kube/config <span class="p">|</span> head -n <span class="m">1</span> <span class="p">|</span> awk <span class="s1">&#39;{print $2}&#39;</span> <span class="p">|</span> base64 -d &gt;&gt; kubecfg.key
$ openssl pkcs12 -export -clcerts -inkey kubecfg.key -in kubecfg.crt -out kubecfg.p12 -name <span class="s2">&#34;kubernetes-client&#34;</span>
</code></pre></td></tr></table>
</div>
</div><p>第三条命令生成证书的时候会提示输入密码，我选择两次回车直接跳过。</p>
<p><code>kubecfg.p12</code> 文件可以存放在 <code>~/.kube</code> 里。</p>
<p><code>kubecfg.p12</code> 是需要导入客户端PC机器的证书，通过 <code>scp</code> 命令：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash">$ scp root@<span class="o">{</span>master节点的ip<span class="o">}</span>:/root/.kube/kubecfg.p12 ./
</code></pre></td></tr></table>
</div>
</div><p>然后在PC端，安装 <code>kubecfg.p12</code> 文件。</p>
<p>通过浏览器，登录 Dashboard 面板，访问的地址：<code>https://{k8s-master-ip}:6443/api/v1/namespaces/kubernetes-dashboard/services/https:kubernetes-dashboard:/proxy/#/login</code> ，登录时可能是一个不安全链接，需要选择继续访问，然后浏览器会提示选择证书，确认将会进入登录界面。</p>
<blockquote>
<p>如果没有跳出验证证书的窗口，需要关闭浏览器，重新打开输入地址。</p>
</blockquote>
<p><img src="https://yijiu-blog.oss-cn-hongkong.aliyuncs.com/images/cloudnative/k8s/setup/Dashboard-login.png?x-oss-process=style/blog-image" alt="Dashboard-login"></p>
<p>选择 <strong>Token</strong> 方式登录，执行<code>kubectl -n kube-system describe secret $(kubectl -n kube-system get secret | grep admin-user | awk '{print $1}')</code> , 获取 <strong>Token</strong> 。</p>
<p>复制得到的 token到页面里输入，点击登录即可，效果如下：</p>
<p><img src="https://yijiu-blog.oss-cn-hongkong.aliyuncs.com/images/cloudnative/k8s/setup/Dashboard.png?x-oss-process=style/blog-image" alt="Dashboard"></p>
<h3 id="添加-worker-节点"><strong>添加 Worker 节点</strong></h3>
<p>Worker 节点的操作从 <code>准备工作</code> 到 <code>配置网络</code> 步骤不变，现在开始部署 Worker 节点。</p>
<p>K8s 的 Worker 节点和 Master 节点几乎是相同的，它们运行着的都是一个 kubelet 组件。</p>
<p>唯一区别就是，在 kubeadm init 的过程中，kubelet 启动后，Master 节点上还会自动运行 <code>kube-apiserver</code> 、<code>kube-scheduler</code> 、<code>kube-controller-manger</code> 、这三个系统 Pod。</p>
<p>Worker 节点完成 <code>kubeadm</code> 和 <code>Docker</code> 的安装后，执行部署 Master 节点时生成的 <code>kubeadm join</code> 指令，在 Worker 节点执行下面命令(Master节点初始化时生成)：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash">$ kubeadm kubeadm join 10.0.0.3:6443 --token abcdef.0123456789abcdef <span class="se">\
</span><span class="se"></span>    --discovery-token-ca-cert-hash sha256:cb43abf70cbe7b48d107de76dba1a1e0d1b5d25a8bc5df20d766d82eb353df1f
</code></pre></td></tr></table>
</div>
</div><p>执行完毕后，在 Master 节点 执行命令 <code>kubectl get nodes</code> 查看所有节点状态：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash">$ kubectl get nodes
k8s-master   Ready    master   23h    v1.16.3
k8s-node1    Ready    &lt;none&gt;   2m2s   v1.16.3
</code></pre></td></tr></table>
</div>
</div><p>在 Dashboard 面板也可以查看到：</p>
<p><img src="https://yijiu-blog.oss-cn-hongkong.aliyuncs.com/images/cloudnative/k8s/setup/Dashboard-nodes.png?x-oss-process=style/blog-image" alt="Dashboard-nodes"></p>
<h3 id="小结"><strong>小结</strong></h3>
<p>至此，我从0开始，在云服务器环境下，使用 kubeadm 工具部署了一个Kubernetes 集群，这个集群有一个  Master 节点和一个 Worker 节点，Worker 节点后续还可以扩充。</p>
<h4 id="参考文档"><strong>参考文档</strong></h4>
<ul>
<li>
<p><a href="https://kubernetes.io/">https://kubernetes.io</a></p>
</li>
<li>
<p><a href="https://github.com/kubernetes/dashboard">Dashboard</a></p>
</li>
<li>
<p><a href="https://blog.piaoruiqing.com/2019/09/17/kubernetes-1-installation/#Kubernetes">跟着官方文档从零搭建K8S</a> （大部分步骤参考此文章）</p>
</li>
<li>
<p><a href="https://time.geekbang.org/column/intro/100015201">极客时间 - 深入剖析Kubernetes</a></p>
</li>
</ul>

    </div>

    <div class="post-copyright">
  <p class="copyright-item">
    <span class="item-title">Author</span>
    <span class="item-content">Yijiu</span>
  </p>
  <p class="copyright-item">
    <span class="item-title">LastMod</span>
    <span class="item-content">
        2019-11-10
        
    </span>
  </p>
  
  <p class="copyright-item">
    <span class="item-title">License</span>
    <span class="item-content"><a rel="license noopener" href="https://en.wikipedia.org/wiki/Wikipedia:Text_of_Creative_Commons_Attribution-ShareAlike_3.0_Unported_License" target="_blank">Creative Commons Attribution-ShareAlike License</a></span>
  </p>
</div>
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/linux/">Linux</a>
          <a href="/tags/kubernetes/">Kubernetes</a>
          <a href="/tags/cloud-native/">cloud native</a>
          </div>
      <nav class="post-nav">
        
        <a class="next" href="/post/unix-linux/ch02/">
            <span class="next-text nav-default">第二章 用户、文件操作与联机帮助：编写 who 命令</span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
  <a href="http://localhost:1313/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2019 - 
    2021<span class="heart"><i class="iconfont icon-heart"></i></span><span>Y1jiu - <a href='https://beian.miit.gov.cn/'>蜀ICP备19017120号</a></span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script>



<script type="text/javascript" src="/js/main.min.c99b103c33d1539acf3025e1913697534542c4a5aa5af0ccc20475ed2863603b.js"></script>








</body>
</html>
